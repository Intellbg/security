{% load static %}

<head>

  <style>
    .ui-autocomplete {
      z-index: 9999;
      cursor: default;
      border: 1px solid #ccc;
      background-color: #fff;
      width: 300px;
    }

    .ui-autocomplete .ui-menu-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .ui-autocomplete .ui-menu-item-wrapper {
      color: #333;
    }

    .ui-autocomplete .ui-menu-item-wrapper:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<div id="editPersonPermissionsModal" class="modal fade modal-md" role="dialog">
  <div class="modal-dialog">
    <input type="hidden" name="id" value="" />
    <input type="hidden" name="customer-site-id" id="customer-site-id" value="" />
    <input type="hidden" name="first-name" id="first-name" value="" />
    <input type="hidden" name="last-name" id="last-name" value="" />
    <input type="hidden" name="document_number" id="document_number" value="" />
    <input type="hidden" name="celular" id="celular" value="" />
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
        <div style="clear: both"></div>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div name="editPersonPermissionsModalTitle"> </div>
        </div>
        <form id="editPersonPermissionsForm">
          <div class="mb-3">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control ui-autocomplete" id="address" required />
            <input type="hidden" id="house-id" name="house-id" />
          </div>
          <div class="mb-3">
            <label class="form-label">Relación Familiar</label>
            <select class="form-select form-control" id="relation-select" name="relation-select" required>
              <option value="O">Dueño</option>
              <option value="C">Pareja</option>
              <option value="CR">Hijo</option>
              <option value="R">Pariente</option>
              <option value="F">Amigo</option>
              <option value="T">Inquilino</option>
              <option value="OT">Otro</option>
            </select>
          </div>
          <div class="form-check">
            <input type="checkbox" value="" id="can_use_passe_id" />
            <label class="form-label" for="can_use_passe_id">
              Puede usar Passe ID
            </label>
          </div>
          <div class="form-check">
            <input type="checkbox" value="" id="can_send_invitations" />
            <label class="form-label" for="can_send_invitations">
              Puede enviar invitaciones por la app.
            </label>
          </div>
          <div class="form-check">
            <input type="checkbox" value="" id="can_send_external" />
            <label class="form-label" for="can_send_external">
              Puede enviar invitaciones por medios externos.
            </label>
          </div>
          <div class="form-group col-md-10 col-sm-10"></div>
          <div style="clear: both"></div>
          <div id="editPersonPermissionsStatusMessage"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" id="editPersonPermissionsButton" class="btn btn-success">
          Autorizar
        </button>
        </form>
        <button type="button" class="btn btn-default" data-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script src="{% static 'js/sb-admin.min.js' %}"></script>
  <script type="text/javascript">
    $(document).ready(() => {
      const getHouses = (callback) => {
        $.ajax({
          url: `/api/v3/households/`,
          type: "GET",
          dataSrc: "results",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
          success: function (response) {
            const houses = response.results.map((house) => ({
              label: house.address,
              value: house.id,
            }));
            callback(houses);
          },
          error: function (xhr, status, error) {
            console.error(error);
            callback([]);
          },
        });
      };

      $("#editPersonPermissionsModal").on("shown.bs.modal", function () {
        getHouses((houses) => {
          $("#address").autocomplete({
            source: houses,
            select: function (event, ui) {
              $("#address").val(ui.item.label);
              $("#house-id").val(ui.item.value);
              return false;
            },
          });
        });
      });
      $("#editPersonPermissionsModal").on("hidden.bs.modal", function () {
        $("#editPersonPermissionsStatusMessage").hide();
      });
      $("#editPersonPermissionsForm").submit((event) => {
        event.preventDefault();
        const first_name = $("#first-name").val();
        const last_name = $("#last-name").val();
        const document_number = $("#document_number").val();
        const celular = $("#celular").val();
        const relation = $("#relation-select").val();
        const is_blocked = $("#is_blocked").is(":checked");
        const can_use_passe_id = $("#can_use_passe_id").is(":checked");
        const can_send_invitations = $("#can_send_invitations").is(":checked");
        const can_send_external = $("#can_send_external").is(":checked");
        const house_id = $("#house-id").val();
        const customerSiteId = $('#customer-site-id').val();

        const newPersonData = {
          person: {
            first_name,
            last_name,
            document_number,
            celular,
          },
          house: house_id,
          is_blocked,
          relation,
          can_use_passe_id,
          can_send_invitations,
          can_send_external,
        };
        const customerSiteData = {
          site_approve: true,
          using_passe_id: can_use_passe_id,
          can_send_external: can_send_external,
          using_app: can_send_invitations,
        };
        const showError = (id, xhr) => {
          const { responseJSON } = xhr;
          const getError = () => {
            if (responseJSON) {
              let errors = "";
              for (const [key, value] of Object.entries(responseJSON)) {
                errors = errors + value[0];
              }
              return errors;
            }
            return false;
          };
          const error = getError();
          $(`#${id}`)
            .text(error || "Ha ocurrido un error")
            .addClass("alert alert-danger text-center mt-3")
            .show();
        };

        const costumerSiteUpdate = () => {
          $.ajax({
            url: `/api/v3/person-site/${customerSiteId}/`,
            type: "PATCH",
            data: JSON.stringify(customerSiteData),
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
              $("#editPersonPermissionsModal").modal("hide");
              $("#myTable").DataTable().ajax.reload();
            },
            error: (xhr, status, error) => {
              console.log(error);
            },
          });
        };

        const createPerson = () => {
          $.ajax({
            url: `/api/v3/household-person/`,
            type: "POST",
            data: JSON.stringify(newPersonData),
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
              costumerSiteUpdate();
            },
            error: (xhr, status, error) => {
              showError("editPersonPermissionsStatusMessage", xhr);
            },
          });
        };

        createPerson();
      });
    });

  </script>
</div>