{% load static %}
<div id="createHouseModal" class="modal fade modal-md" role="dialog">
  <div class="modal-dialog">
    <input type="hidden" name="id" value="" />
    <input type="hidden" name="is_blocked" value="" />
    <div class="modal-content">
      <div class="modal-header">
       <form id="createHouseForm">

       
        <button type="button" id ="closeCreateHouseModal"class="close" data-dismiss="modal">
          &times;
        </button>
        <div style="clear: both"></div>
      </div>
      <div class="modal-body">
        <!-- Form -->
        <div class="form-group col-md-10 col-sm-10">
          <div class="mb-3">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control" id="address" required />
          </div>
          <div class="form-check">
            <input type="checkbox" value="" id="is_blocked" />
            <label class="form-label" for="is_blocked">
              ¿Esta bloqueada?
            </label>
          </div>
        </div>
      </div>
      <div id="createHouseStatusMessage"></div>
      <div class="modal-footer">
        <button type="submit" id="createButton" class="btn btn-primary">
          Crear
        </button>
        <button type="button" class="btn btn-default" data-dismiss="modal">
          Cerrar
        </button>
      </form>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function () {
      $("#createHouseModal").on("hidden.bs.modal", function () {
        $("#createHouseStatusMessage").hide();
        $("#address").val("");
        $("#is_blocked").prop("checked", false);
      })
      $("#createHouseForm").submit(function (event) {
        event.preventDefault();
        var formData = {
          address: $("#address").val(),
          is_blocked: $("#is_blocked").is(":checked"),
          site: "{{ request.user.administrator.first.site.id }}",
        };
        const showError = (id, xhr) => {
          const { responseJSON } = xhr;
          const getError = () => {
            if (responseJSON) {
              let errors = "";
              for (const [key, value] of Object.entries(responseJSON)) {
                errors = errors + value[0];
              }
              return errors;
            }
            return false;
          };
          const error = getError();
          $(`#${id}`)
            .text(error || "Ha ocurrido un error")
            .addClass("alert alert-danger text-center mt-3")
            .show();
        };

        if (!formData.address) {
          alert("Por favor, ingrese una dirección");
        } else {
          $.ajax({
            url: `/api/v3/households/`,
            method: "POST",
            data: JSON.stringify(formData),
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
              $("#createHouseModal").modal("hide");
              $("#myTable").DataTable().ajax.reload();
            },
            error: (xhr, status, error) => {
              showError("createHouseStatusMessage", xhr);
            },
          });
        }
      });
    });
  </script>
</div>
